# app/main.py (ìµœì¢… ì •ë¦¬ ë²„ì „)

from fastapi import FastAPI                                                   # [1] FastAPI ì•± ìƒì„±
from fastapi.middleware.cors import CORSMiddleware                            # [2] CORS ì •ì±… ì ìš©
from .api.v1 import api_router                                                # [3] API ë¼ìš°í„°
from .db.session import init_tortoise                                         # [4] Tortoise ORM ì´ˆê¸°í™” í•¨ìˆ˜


# =====================================================================
# 1) FastAPI ì•± ìƒì„±
# =====================================================================
app = FastAPI(
    title="My Diary API",                                                     # [5] Swagger ë¬¸ì„œ ì œëª©
    version="1.0.0",                                                          # [6] API ë²„ì „
    docs_url="/docs",                                                         # [7] Swagger UI ê²½ë¡œ
    redoc_url=None                                                            # [8] Redoc ë¹„í™œì„±í™”
)
"""
ë™ì‘ ì›ë¦¬:
- FastAPI ì•±ì´ ìƒì„±ë˜ë©´ routing table, middleware stack, event hooks êµ¬ì¡°ê°€ ì´ˆê¸°í™”ë¨
- ì´í›„ CORS ì¶”ê°€, ORM ì´ˆê¸°í™”, ë¼ìš°í„° ë“±ë¡ì„ ìˆœì„œëŒ€ë¡œ êµ¬ì„±í•  ìˆ˜ ìˆìŒ
"""


# =====================================================================
# 2) CORS ì„¤ì •
# =====================================================================
origins = ["*"]                                                                # [9] ëª¨ë“  ë„ë©”ì¸ í—ˆìš© (ê°œë°œ í™˜ê²½)
app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,                                                     # [10] ìš”ì²­ origin í—ˆìš© ë¦¬ìŠ¤íŠ¸
    allow_credentials=True,                                                    # [11] ì¿ í‚¤/ì¸ì¦ í—¤ë” í—ˆìš©
    allow_methods=["*"],                                                       # [12] ëª¨ë“  HTTP ë©”ì„œë“œ í—ˆìš©
    allow_headers=["*"],                                                       # [13] ëª¨ë“  ìš”ì²­ í—¤ë” í—ˆìš©
)
"""
ë™ì‘ ì›ë¦¬:
- ë¸Œë¼ìš°ì € í™˜ê²½(React/Vue/Next ë“±)ì—ì„œ API ì ‘ê·¼ ì‹œ CORS ì •ì±… ìœ„ë°˜ì„ ë°©ì§€
- ì‹¤ì œ ë°°í¬ í™˜ê²½ì—ì„œëŠ” originsë¥¼ íŠ¹ì • ë„ë©”ì¸ìœ¼ë¡œ ì œí•œí•˜ëŠ” ê²ƒì´ ë³´ì•ˆì— ìœ ë¦¬í•¨
"""


# =====================================================================
# 3) Tortoise ORM ì´ˆê¸°í™”
# =====================================================================
init_tortoise(app)                                                             # [14] DB ì—°ê²° ì´ˆê¸°í™”
"""
ë™ì‘ ì›ë¦¬:

init_tortoise(app)ì€ ë‚´ë¶€ì—ì„œ register_tortoise()ë¥¼ í˜¸ì¶œí•¨.
register_tortoise() ë‚´ë¶€ ë™ì‘:

    âœ” FastAPIì˜ lifecycle eventì— hook ë“±ë¡

        app.add_event_handler("startup", tortoise_init_function)
        app.add_event_handler("shutdown", tortoise_close_function)

    âœ” startup ì‹œ ì‹¤í–‰ë˜ëŠ” ì‘ì—…
        - DB ì—°ê²°(Tortoise.init)
        - ëª¨ë¸ ìŠ¤ìº”
        - ORM ë©”íƒ€ë°ì´í„° ìƒì„±

    âœ” shutdown ì‹œ ì‹¤í–‰ë˜ëŠ” ì‘ì—…
        - DB ì—°ê²° ì•ˆì „ ì¢…ë£Œ

ì¦‰, init_tortoise(app) í•¨ìˆ˜ëŠ” ì§ì ‘ DBì— ì—°ê²°í•˜ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,
"FastAPIê°€ ì‹¤í–‰ë  ë•Œ ìë™ìœ¼ë¡œ DBê°€ ì´ˆê¸°í™”ë˜ë„ë¡" ì´ë²¤íŠ¸ë¥¼ ì—°ê²°í•˜ëŠ” í•¨ìˆ˜ì´ë‹¤.

ğŸ’¡ ìœ„ì¹˜ ì¤‘ìš”:
- ë¯¸ë“¤ì›¨ì–´ ì¶”ê°€ í›„
- ë¼ìš°í„° ë“±ë¡ ì „ì— ì‹¤í–‰í•˜ëŠ” ê²ƒì´ ê°€ì¥ ì•ˆì •ì ì„
"""


# =====================================================================
# 4) ë¼ìš°í„° ë“±ë¡
# =====================================================================
app.include_router(api_router, prefix="/api/v1")                              # [15] API ì—”ë“œí¬ì¸íŠ¸ ë¬¶ìŒ ë“±ë¡
"""
ë™ì‘ ì›ë¦¬:
- ëª¨ë“  v1 ì—”ë“œí¬ì¸íŠ¸ê°€ /api/v1/* ê²½ë¡œì— ìë™ìœ¼ë¡œ í¬í•¨ë¨
- ì˜ˆ: /questions/random â†’ /api/v1/questions/random
- ë¼ìš°í„°ëŠ” DB ì´ˆê¸°í™”ë³´ë‹¤ ë‚˜ì¤‘ì— ë“±ë¡í•˜ëŠ” ê²ƒì´ ì¼ë°˜ì ì¸ êµ¬ì¡°
"""


# ==========================
# ì•± ì´ˆê¸°í™” ì™„ë£Œ
# ==========================

